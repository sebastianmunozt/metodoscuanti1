<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Clase 5</title>
    <meta charset="utf-8" />
    <meta name="author" content="Sebastián Muñoz" />
    <meta name="author" content="Gino Ocampo" />
    <meta name="date" content="2023-11-06" />
    <script src="Clase-11-Presentación_files/header-attrs/header-attrs.js"></script>
    <script src="Clase-11-Presentación_files/kePrint/kePrint.js"></script>
    <link href="Clase-11-Presentación_files/lightable/lightable.css" rel="stylesheet" />
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# Clase 5
]
.subtitle[
## Data Wrangling y ggplot2
]
.author[
### Sebastián Muñoz
]
.author[
### Gino Ocampo
]
.date[
### 2023-11-06
]

---







## En esta clase


### 1. Repaso

### 2. Data Wrangling

#### 2.1 Limpieza de datos

#### 2.2 Transformación de variables

#### 2.3 Exportar

### 3. Gráficos con ggplot


---
class: inverse, center, middle

# 1. Repaso

---
# De persona novata a experta

![novato](img/novato.png)

---
# De persona novata a experta

![experto](img/experto.png)
---

### Flujo de trabajo

![flujo](img/flujo.png)

---
### Orden de script

![datos](img/orden script.png)



---

## Tipos de datos

![datos](img/Rvariablesdata.jpg)

---
## Listas

![datos](img/list.jpg)


---

#Importación de bases de datos
A la hora de importar una base de datos nos podemos llegar a enfrentar a distintos tipos de archivos. En R contamos con **distintos paquetes y funciones** según el **tipo de extensión** del archivo:    

&lt;table class="table table-striped table-hover" style="margin-left: auto; margin-right: auto;"&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; Tipo de archivo &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; Paquete &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; Extension &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; Funciones &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Texto Plano &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; readr &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; .csv &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; read_csv() &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Texto Plano &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; readr &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; .txt &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; read_txt() &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Texto Plano &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; readr &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; .tsv &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; read_tsv() &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Extension de R &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; RBase &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; .RDS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; readRDS() &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Extension de R &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; RBase &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; .RDATA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; open() &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Otros Softwares &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; haven &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; .dta &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; read_dta() &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Otros Softwares &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; haven &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; .sav &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; read_spss() &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Excel &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; openxlsx &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; .xlsx &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; read.xlsx() &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Excel &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; readxl &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; .xls &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; read_excel() &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---
#Importación de bases de datos

El primer y más importante parámetro de las funciones para importar datos suele llamarse  **`file`**. Allí debemos especificar la ruta hasta el archivo, incluyendo la extensión del mismo. 

Si tenemos abierto un proyecto, el punto de partida para la ruta a especificar será la carpeta del proyecto. Si queremos ir hacia atrás en las carpetas agregamos  **`../`**

```r
base.vacunas&lt;- read_csv(
  file = "../Fuentes/Covid19VacunasAgrupadas.csv")    

base.covid &lt;- readRDS(file = "../Fuentes/base_covid_sample.RDS")
```
**IMPORTANTE**: Siempre que lean bases de datos asignarlas a un nuevo objeto. De lo contrario, las va a mostrar completas en consola y no va a guardarlas en el ambiente de trabajo (enviroment)
---
#Exportación de resultados
Por lo general, cada paquete que presenta funciones para importar bases de dato, tiene como complemento una función para exportar (guardar en el disco de nuestra PC) un objeto con la misma extensión. Ejemplos: 


 - el paquete **openxlsx** tiene una función denominada **`write.xlsx()`** que nos permite exportar un dataframe creando un archivo **.xslx**
 - En RBase la función **`saveRDS()`** nos permite exportar archivos de extensión **.RDS** (son menos pesados para trabajarlos luego desde R)

En general estas funciones tienen un primer parametro para especificar el objeto a exportar, y un segundo para especificar la ruta y el nombre de archivo a crear ()


```r
write.xlsx(x = objeto_resultados,file = "Resultados/cuadro1.xlsx")

saveRDS(object = objeto_resultados,file = "Resultados/base_nueva.RDS")
```
---
class: inverse, center, middle

# 2. Data Wrangling

---
class: center, middle

# 2.1 Limpieza de datos
## Janitor
![datos](img/janitor.jpg)

---
## Limpiar nombres de variables

En general los nombres de las variables de bases de datos (en bruto) tienen la forma 

```r
library(openxlsx)
datos &lt;- read.xlsx(xlsxFile = "base/Encuesta Estudiantes Antropología 2023 (respuestas).xlsx", 
                   startRow = 2)
#extraigo el nombre de todas las variables
names (datos)
```

```
##  [1] "Marca.temporal"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
##  [2] "p02..Edad.del(a).entrevistado/"                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
##  [3] "p03..Género.del/a.entrevistado/a"                                                                                                                                                                                                                                                                                                                                                                                                                                                               
##  [4] "p04..Año.en.que.se.encuentra.de.la.carrera.(1°,.2°,.3°,.4°,.5°,.)."                                                                                                                                                                                                                                                                                                                                                                                                                             
##  [5] "p05..Comuna.actual.de.residencia"                                                                                                                                                                                                                                                                                                                                                                                                                                                               
##  [6] "p06..Comuna.de.residencia.de.su.familia.nuclear.(padres,.hermanos/as.u.otros/as.cuidadores).o.en.la.que.vivió.la.mayor.parte.de.infancia.y.adolescencia."                                                                                                                                                                                                                                                                                                                                       
##  [7] "p07..Último.tipo.de.establecimiento.educativo.en.que.realizó.su.enseñanza.media"                                                                                                                                                                                                                                                                                                                                                                                                                
##  [8] "p08..Puntaje.final.obtenido.en.la.prueba.de.selección.universitaria.(ponderado.según.carrera.elegida)"                                                                                                                                                                                                                                                                                                                                                                                          
##  [9] "p09..¿Cuál.de.estas.situaciones.describe.mejor.su.actividad.principal.durante.el.último.mes?"                                                                                                                                                                                                                                                                                                                                                                                                   
## [10] "p10..Indique.el.máximo.nivel.educativo.alcanzado.por.su.MADRE"                                                                                                                                                                                                                                                                                                                                                                                                                                  
## [11] "p11..¿Actualmente.su.MADRE.trabaja?"                                                                                                                                                                                                                                                                                                                                                                                                                                                            
## [12] "p12..¿Cuál.es.la.ocupación.u.oficio.actual.de.su.MADRE?.Describa.las.principales.tareas.y.funciones.en.el.puesto.de.trabajo.actual.de.su.madre"                                                                                                                                                                                                                                                                                                                                                 
## [13] "p13..Indique.el.máximo.nivel.educativo.alcanzado.por.su.PADRE"                                                                                                                                                                                                                                                                                                                                                                                                                                  
## [14] "p14..¿Actualmente.su.PADRE.trabaja?"                                                                                                                                                                                                                                                                                                                                                                                                                                                            
## [15] "p15..¿Cuál.es.la.ocupación.u.oficio.actual.de.su.PADRE?.Describa.las.principales.tareas.y.funciones.en.el.puesto.de.trabajo.actual.de.su.padre"                                                                                                                                                                                                                                                                                                                                                 
## [16] "p17..¿Quién.es.el.principal.sostenedor/a.de.su.hogar.ACTUAL?.(quien.aporta.más.al.presupuesto.mensual)"                                                                                                                                                                                                                                                                                                                                                                                         
## [17] "p18..En.la.sociedad,.comúnmente,.existen.distintos.grupos.o.clases.sociales..Las.personas.de.clase.social.alta.son.las.que.tienen.los.ingresos.más.altos,.el.mayor.nivel.de.educación.y.los.trabajos.más.valorados..Las.personas.de.clase.social.baja.son.las.que.tienen.los.ingresos.más.bajos,.el.menor.nivel.de.educación.y.los.trabajos.menos.valorados..Entre.estas.clases.existen.otras.intermedias:.Según.su.opinión,.a.cuál.de.los.siguientes.grupos.o.clases.sociales.pertenece.usted:"
## [18] "p19..Actualmente.en.su.casa.¿Tienen.Computador.(ya.sea.notebook.o.de.escritorio).?"                                                                                                                                                                                                                                                                                                                                                                                                             
## [19] "p20..Actualmente.USTED.¿tiene.Computador.para.uso.personal.(ya.sea.notebook.o.de.escritorio)?"                                                                                                                                                                                                                                                                                                                                                                                                  
## [20] "p21..Actualmente.USTED.¿Tiene.smartphone.personal?"                                                                                                                                                                                                                                                                                                                                                                                                                                             
## [21] "p22..¿Con.qué.frecuencia.escucha.música?"                                                                                                                                                                                                                                                                                                                                                                                                                                                       
## [22] "p23..¿Qué.tipo.de.música.es.la.que.MÁS.prefiere.escuchar?.[Aun.cuándo.escuche.más.de.un.estilo,.elija.el.que.MÁS.escuche]"                                                                                                                                                                                                                                                                                                                                                                      
## [23] "p24..Si.eligió.otra,.¿Cuál?"                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
## [24] "p25.¿Cuál.es.la.segunda.música.que.más.prefiere.escuchar?"                                                                                                                                                                                                                                                                                                                                                                                                                                      
## [25] "p26..Si.eligió.otra,.¿Cuál?"                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
## [26] "p27..¿Con.qué.dispositivo.suele.escuchar.más.música?"                                                                                                                                                                                                                                                                                                                                                                                                                                           
## [27] "p28.¿Cuál.es.principal.sitio,.programa.o.aplicación.para.bajar.o.escuchar.música?"                                                                                                                                                                                                                                                                                                                                                                                                              
## [28] "p29..si.respondió.otro,.¿Cuál?"                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
## [29] "p30..¿Cuál.es.la.red.social.en.que.pasa.más.tiempo?"                                                                                                                                                                                                                                                                                                                                                                                                                                            
## [30] "p31..si.respondió.otra,.¿Cuál?"                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
## [31] "p32..Y.¿Cuál.es.la.segunda.red.social.en.que.pasa.más.tiempo?"                                                                                                                                                                                                                                                                                                                                                                                                                                  
## [32] "p33..si.respondió.otra,.¿Cuál?"
```


 

---

## Limpiar nombres de variables 1


```r
# Janitor
#install.packages("janitor")
library(janitor)

datos &lt;- janitor::clean_names(datos)# transformo todo a minúscula, quito tildes, saco signos, borro espacios
```
---

## Limpiar nombres de variables



```r
library(openxlsx)
datos &lt;- read.xlsx(xlsxFile = "base/Encuesta Estudiantes Antropología 2023 (respuestas).xlsx", 
                   startRow = 2)
datos &lt;- janitor::clean_names(datos)
names (datos)
```

```
##  [1] "marca_temporal"                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
##  [2] "p02_edad_del_a_entrevistado"                                                                                                                                                                                                                                                                                                                                                                                                                                                         
##  [3] "p03_genero_del_a_entrevistado_a"                                                                                                                                                                                                                                                                                                                                                                                                                                                     
##  [4] "p04_ano_en_que_se_encuentra_de_la_carrera_1_2_3_4_5"                                                                                                                                                                                                                                                                                                                                                                                                                                 
##  [5] "p05_comuna_actual_de_residencia"                                                                                                                                                                                                                                                                                                                                                                                                                                                     
##  [6] "p06_comuna_de_residencia_de_su_familia_nuclear_padres_hermanos_as_u_otros_as_cuidadores_o_en_la_que_vivio_la_mayor_parte_de_infancia_y_adolescencia"                                                                                                                                                                                                                                                                                                                                 
##  [7] "p07_ultimo_tipo_de_establecimiento_educativo_en_que_realizo_su_ensenanza_media"                                                                                                                                                                                                                                                                                                                                                                                                      
##  [8] "p08_puntaje_final_obtenido_en_la_prueba_de_seleccion_universitaria_ponderado_segun_carrera_elegida"                                                                                                                                                                                                                                                                                                                                                                                  
##  [9] "p09_cual_de_estas_situaciones_describe_mejor_su_actividad_principal_durante_el_ultimo_mes"                                                                                                                                                                                                                                                                                                                                                                                           
## [10] "p10_indique_el_maximo_nivel_educativo_alcanzado_por_su_madre"                                                                                                                                                                                                                                                                                                                                                                                                                        
## [11] "p11_actualmente_su_madre_trabaja"                                                                                                                                                                                                                                                                                                                                                                                                                                                    
## [12] "p12_cual_es_la_ocupacion_u_oficio_actual_de_su_madre_describa_las_principales_tareas_y_funciones_en_el_puesto_de_trabajo_actual_de_su_madre"                                                                                                                                                                                                                                                                                                                                         
## [13] "p13_indique_el_maximo_nivel_educativo_alcanzado_por_su_padre"                                                                                                                                                                                                                                                                                                                                                                                                                        
## [14] "p14_actualmente_su_padre_trabaja"                                                                                                                                                                                                                                                                                                                                                                                                                                                    
## [15] "p15_cual_es_la_ocupacion_u_oficio_actual_de_su_padre_describa_las_principales_tareas_y_funciones_en_el_puesto_de_trabajo_actual_de_su_padre"                                                                                                                                                                                                                                                                                                                                         
## [16] "p17_quien_es_el_principal_sostenedor_a_de_su_hogar_actual_quien_aporta_mas_al_presupuesto_mensual"                                                                                                                                                                                                                                                                                                                                                                                   
## [17] "p18_en_la_sociedad_comunmente_existen_distintos_grupos_o_clases_sociales_las_personas_de_clase_social_alta_son_las_que_tienen_los_ingresos_mas_altos_el_mayor_nivel_de_educacion_y_los_trabajos_mas_valorados_las_personas_de_clase_social_baja_son_las_que_tienen_los_ingresos_mas_bajos_el_menor_nivel_de_educacion_y_los_trabajos_menos_valorados_entre_estas_clases_existen_otras_intermedias_segun_su_opinion_a_cual_de_los_siguientes_grupos_o_clases_sociales_pertenece_usted"
## [18] "p19_actualmente_en_su_casa_tienen_computador_ya_sea_notebook_o_de_escritorio"                                                                                                                                                                                                                                                                                                                                                                                                        
## [19] "p20_actualmente_usted_tiene_computador_para_uso_personal_ya_sea_notebook_o_de_escritorio"                                                                                                                                                                                                                                                                                                                                                                                            
## [20] "p21_actualmente_usted_tiene_smartphone_personal"                                                                                                                                                                                                                                                                                                                                                                                                                                     
## [21] "p22_con_que_frecuencia_escucha_musica"                                                                                                                                                                                                                                                                                                                                                                                                                                               
## [22] "p23_que_tipo_de_musica_es_la_que_mas_prefiere_escuchar_aun_cuando_escuche_mas_de_un_estilo_elija_el_que_mas_escuche"                                                                                                                                                                                                                                                                                                                                                                 
## [23] "p24_si_eligio_otra_cual"                                                                                                                                                                                                                                                                                                                                                                                                                                                             
## [24] "p25_cual_es_la_segunda_musica_que_mas_prefiere_escuchar"                                                                                                                                                                                                                                                                                                                                                                                                                             
## [25] "p26_si_eligio_otra_cual"                                                                                                                                                                                                                                                                                                                                                                                                                                                             
## [26] "p27_con_que_dispositivo_suele_escuchar_mas_musica"                                                                                                                                                                                                                                                                                                                                                                                                                                   
## [27] "p28_cual_es_principal_sitio_programa_o_aplicacion_para_bajar_o_escuchar_musica"                                                                                                                                                                                                                                                                                                                                                                                                      
## [28] "p29_si_respondio_otro_cual"                                                                                                                                                                                                                                                                                                                                                                                                                                                          
## [29] "p30_cual_es_la_red_social_en_que_pasa_mas_tiempo"                                                                                                                                                                                                                                                                                                                                                                                                                                    
## [30] "p31_si_respondio_otra_cual"                                                                                                                                                                                                                                                                                                                                                                                                                                                          
## [31] "p32_y_cual_es_la_segunda_red_social_en_que_pasa_mas_tiempo"                                                                                                                                                                                                                                                                                                                                                                                                                          
## [32] "p33_si_respondio_otra_cual"
```


---
## Limpiar nombres de variables 2

### Existen nombres de variables muy largos, los quiero acortar.

1. Genero un vector con todas las columnas que quiero renombrar


```r
cols_a_renombrar &lt;- c( 
"marca_temporal",
"p02_edad_del_a_entrevistado",
"p03_genero_del_a_entrevistado_a",
"p04_ano_en_que_se_encuentra_de_la_carrera_1_2_3_4_5",
"p05_comuna_actual_de_residencia")
```

---
## Limpiar nombres de variables

### Extraer las primeras letras de variables: hacerlas más sencillas para procesar.

2. Genero un vector sólo con las 3 primeras letras: p01


```r
library(tidyverse)

nuevos_nombres &lt;- str_sub(string = cols_a_renombrar, start = 1, end = 3) #muestro los argumentos
nuevos_nombres
```


+ **primer argumento** - string = de donde saco los nombres: el vector creado

+ **segundo argumento** - start = desde que posición extraigo (p)

+ **tercer argumento** - end= hasta donde (1)

---
## Limpiar nombres de variables

### Asignar nuevos nombres

3. Renombro considerando todas las columnas elegidas asignando nuevos nombres


```r
datos &lt;- datos %&gt;%
  rename_at(vars(cols_a_renombrar), ~ nuevos_nombres) #recodificación múltiples con un vector
```

+ **rename_at**: renombra las siguientes columnas y ponle estos nombres

+ **cols_a_renombrar**: son las columnas a renombrar

+ **~**: es el signo que me indica una relación de transformación

+ **nuevos nombres**: son los nuevos nombres que van adquirir las variables
---
## Limpiar nombres de variables

### Asignar nuevos nombres

4. Renombro algunas variables en específico
Posibilidad de renombrar uno por uno las variables de interés. 


```r
libro_códigos &lt;- read.xlsx(xlsxFile = "base/Encuesta Estudiantes Antropología 2023 (respuestas).xlsx", startRow = 2)
names(libro_códigos)

datos &lt;- datos %&gt;% dplyr::rename(  # primero nuevo nombre y luego nombre antiguo
                        edad = p02, 
                        genero = p03, 
                        annio = p04, 
                        comuna_actual = p05, 
                        comuna_pre= p06, 
                        tipo_colegio = p07, 
                        puntaje = p08, 
                        estudio_trabajo = p09, 
                        educacion_madre = p10, 
                        trabaja_madre =p11, 
                        empleo_madre =p12, 
                        educacion_padre =p13, 
                        trabaja_padre =p14, 
                        empleo_padre = p15, 
                        psdhogar = p17, 
                        clase_social_subjetiva = p18)
```
---
## Limpiar nombres de variables

Finalmente observo los nombres de mis nuevas variables


```r
names(datos)
```
 [1] "mar"                    "edad"                   "genero"                
 [4] "annio"                  "comuna_actual"          "comuna_pre"            
 [7] "tipo_colegio"           "puntaje"                "estudio_trabajo" 
---
class: center, middle

# 2.2 Transformación de variables

---
## Transformaciones/limpieza en variables numéricas

Limpieza inicial de variables numéricas


```r
table(datos$edad) # vemos el ingreso de una variable que dice "años"
class (datos$edad) # Se considera "character"
```
&gt; table(datos$edad) # vemos que hay un caso que dice "años"

     19      20      21      22      23 24 años      30 
      1       8       4       3       3       1       1 
&gt; class (datos$edad) # Se considera "character"
[1] "character"

Lee la variable como `character` porque existe una observación que dice años

---
## Transformaciones/limpieza en variables numéricas

Limpieza inicial de variables numéricas

Eliminamos todo lo que no sea número de la variable numérica

```r
datos$edad &lt;- as.numeric(gsub("[^0-9]+", "", datos$edad)) # elimino todo lo que no es número
```
## Explicación: 
* **[^0-9]** busca cualquier secuencia de caracteres que no sean dígitos (0-9)
  + los reemplaza con una cadena vacía "". 
  + elimina cualquier carácter que no sea numérico de la columna "edad"
  + as.numeric: transforma en numérico. 
---
## Transformaciones/limpieza en variables numéricas

Limpieza inicial de variables numéricas

Finalmente se comprueba si la transformación resulta correctamente


```r
class (datos$edad) # compruebo si es numérico
table(datos$edad) # observo como quedó variable
```
.pull-left[
* class (datos$edad) # compruebo si es numérico
* table(datos$edad) # observo como quedó variable

]
.pull-right[ 
| Edad | Frecuencia |
|-------------- | -------------- |
| 19           | 1              |
| 20           | 8              |
| 21           | 4              |
| 22           | 3              |
| 23           | 3              |
| 24           | 1              |
| 30           | 1              |
]
 
---
# Transformación de variables

Recodificación de tipo de medición de variable: paso de `numérica` a `ordinal`

Existen 2 funciones que usamos de manera combinada, `mutate` y `case_when`


```r
datos &lt;- datos %&gt;% 
  mutate (edadr= case_when (edad %in% c(18:20) ~ "18 a 20", 
                            edad %in% c(21:23) ~ "21 a 23", 
                            edad &gt;= 24 ~ "24 o más"))
```

+ **mutate**: función para modificar/crear variables
+ **edadr**: variable nueva
+ **case_when**: argumumento al interior de mutate para decir, cuando se da "x" transformalo en "y"
+ **edad**: variable vieja
+ **~**: indica la modificación



---
# Recordemos los operadores lógicos

.pull-left[

| Operador | Descripción             | Ejemplo                              |
|----------|-------------------------|--------------------------------------|
| ==       | Igual a                 | `edad == 5`                          |
| !=       | No es igual a           | `sexo != "F"`                        |
| &lt;        | Menor que               | `edad &lt; 18`                          |
| &gt;        | Mayor que               | `edad &gt; 18`                          |
| &lt;=       | Menor o igual que       | `edad &lt;= 18`                         |
| &gt;=       | Mayor o igual que       | `edad &gt;= 65`                         |
| &amp;        | Y lógico (AND)          | `sexo != "M" &amp; edad &lt;= 18`            |
]

.pull-left[
+ **&amp;**:  AND: Cuando se cumplen ambas condiciones
+ **|**:  OR: Cuando se cumple una u otra condición
+ **%in%**: Incluye. Lo que está a la izquierda está incluido en lo q está a la derecha
]

---
# Transformación de variables

Recodificación de tipo de medición de variable: paso de `numérica` a `ordinal`.
Comparamos:


```r
table(datos$edad)
table(datos$edadr)
```



.pull-left[
&gt; table(datos$edad)

| Edad | Frecuencia |
|-------------- | -------------- |
| 19           | 1              |
| 20           | 8              |
| 21           | 4              |
| 22           | 3              |
| 23           | 3              |
| 24           | 1              |
| 30           | 1              |
]
 
.pull-right[

&gt; table(datos$edadr)

| Edad recodificada    | Frecuencia |
|----------------- | -------------- |
| 18 a 20          | 9              |
| 21 a 23          | 10             |
| 24 o más         | 2              |

+ entonces: **¿Qué es recodificar?**

] 
 
 
 
---
## Transformaciones/limpieza en variables cualitativas

En las variables categóricas de pregunta abierta cada uno responde como quiere, por lo tanto exite el problema de homogeneizar las respuestas a estas variables para poder analizar posteriormente

```r
table(datos$genero)
table(datos$annio)
table(datos$comuna_actual) #que cosa rara observa? 
table(datos$comuna_pre) #que cosa rara observa? 
```
* ¿Cómo homogeneizo los valores escritos?
+ Algunos tienen mayúsculas y minusculas en diversas letras
+ Algunos usan tildes y otros no
+ Uno escribe `Santiago` y otro `Santiago centro`
---
## Transformaciones/limpieza en variables cualitativas

Homogeinizo categorías de respuesta, sin tildes, en minúsculas y cambio espacios por guión bajo (_)

```r
#saco caracteres típicos del español (ñ), elimino comas y espacios y pongo todo en minuscula

datos &lt;- datos %&gt;%
  mutate(comuna_actual = stringi::stri_trans_general(comuna_actual, "Latin-ASCII"), 
         comuna_actual = tolower (comuna_actual), 
         comuna_actual = gsub(" ", "_", comuna_actual)) 

#Observo
table(datos$comuna_actual) 
```

+ **mutate**: modifica o crea una variable
+ **comuna_actual**: variable nueva
+ **stri_trans_general(comuna_actual, "Latin-ASCII")**:  borra tildes y ñ
+ **tolower (comuna_actual)**: transforma todo en minúscula
+ **comuna_actual = gsub(" ", "_", comuna_actual)**: cambia espacios a _

---
## Transformaciones/limpieza en variables cualitativas

Recodificar con `recode` permite recodificar de manera personalizada las categorías de la variable 

```r
#recodifico
datos &lt;- datos %&gt;%
  mutate(comuna_actual = recode(comuna_actual,
                             "puente_alto_" = "puente_alto",
                             "santiago_centro" = "santiago",
                             "san_felipe,_v_region" = "san felipe", 
                             "paine_" = "paine"))
table(datos$comuna_actual) 
```

+ **mutate**: modifica o crea una variable
+ **comuna_actual**: variable nueva
+ **recode**: función para recodificar
+ **comuna_actual**: variable vieja (se pisan)
+ **la coma**: va separando las distintas recodificaciones
+ **valores viejos** = valores nuevos


---
# Finalmente guardo mi base


```r
dir.create(path = "output")
write.xlsx(x = datos,file = "output/Encuesta_Antropología_Limpia")
```

+ **dir.create**: crea un directorio nuevo
+ **write.xlsx**: crea una base de datos con las modificaciones realizadas

---
class: inverse, center, middle

# 3. Gráficos con ggplot
---
# Gráficos con ggplot

![datos](img/Imagen_ggplot.png)
+ ¿Cómo funciona esto en la práctica? 

---
# Gráficos con ggplot

### ¿Cómo funciona esto en la práctica? 

El caso de uso más simple de ggplot consiste en:

+ una llamada a la función ggplot(), pasándole un dataset y una “asignación de atributos estéticos” (aesthetic mapping en inglés) usando aes()

+ al menos una capa “geom”, que define el recurso gráfico que mostrará los datos; por ejemplo  geom_line() para dibujar líneas o geom_point() para dibujar puntos.

---
## Gráficos con ggplot
![datos](img/ggplot_sintaxis.png)
![datos](img/ggplot_explicacion.png)
---
## Gráficos con ggplot

&lt;img src="img/ggplot.gif" width="100%" /&gt;

---
## Gráficos con ggplot

### Lógica de cebolla anidando las capas con el signo +


```r
ggplot(data= base_a_utilizar, aes(x = variable_1, y = variable_2, 
                                  color =variable_que distingue_color, 
                                  fill=variable_que_rellena,)) + 
  geom_algo()+ 
  labs () + 
  guides()+ 
  theme_() 
```

+ **data**: de dónde salen los datos, cuál es la base/tabla a utilizar
+ **aes**: cuáles serán las variables a considerar
+ **color**: cuáles serán los colores de las líneas
+ **fill** cuáles serán los colores internos
+ **geom_algo()**: qué tipo de gráfico se va a realizar?
+ **labs ()**: cuales serán los títulos?
+ **guides()**: se integra o no un cuadrado donde se mostrarán una descripción de categorías?
+ **theme_()**: se utilizará o no un tema global?




---
## Gráficos de Barra (geom_bar) con ggplot



### Proceso 1: Frecuencias
1) realizo la tabla a graficar

```r
tabla_frecuencia &lt;- table(datos$genero)
df_tabla_frecuencia &lt;- as.data.frame(tabla_frecuencia) # transformo a data.frame
df_tabla_frecuencia #observo tabla
```

```
##         Var1 Freq
## 1   Femenino   11
## 2  Masculino    9
## 3 No Binario    2
```
---
#### Gráficos con ggplot - Proceso 1: Frecuencias
2) realizo gráfico

```r
ggplot(data = df_tabla_frecuencia, aes(x = Var1, y = Freq)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Gráfico de Barras de Género", x = "Género", y = "Frecuencia")
```

&lt;img src="Clase-11-Presentación_files/figure-html/unnamed-chunk-25-1.png" width="100%" /&gt;

---

##Elementos

* **ggplot(data = df_tabla_frecuencia, aes(x = Var1, y = Freq))**: 
  + Esta parte inicia un nuevo gráfico utilizando los datos del DataFrame df_tabla_frecuencia. 
  + aes significa "aesthetics" y aquí se establecen las variables que se utilizarán en el gráfico, donde Var1 se asigna al eje X y Freq al eje Y.

* **geom_bar(stat = "identity", fill = "blue")**: 
  + Agrega una capa de gráfico de barras. 
  + El stat = "identity" significa que los valores de Freq representan directamente las alturas de las barras. 
  + fill = "blue" establece el color de las barras en azul.

* **labs(title = "Gráfico de Barras de Género", x = "Género", y = "Frecuencia")**: 
  + Define etiquetas para el gráfico. 
  + title: establece el título del gráfico como "Gráfico de Barras de Género", x establece la etiqueta del eje X como "Género", y y establece la etiqueta del eje Y como "Frecuencia".


---
#### Gráficos con ggplot

1) Crear la tabla de frecuencia

```r
tabla_frecuencia &lt;- table(datos$genero)
```

2) Creo tabla de porcentajes

```r
porcentajes &lt;- prop.table(tabla_frecuencia) * 100
df_porcentajes &lt;- data.frame(porcentajes) # transformo a data.frame
df_porcentajes #observo tabla
```

```
##         Var1      Freq
## 1   Femenino 50.000000
## 2  Masculino 40.909091
## 3 No Binario  9.090909
```
---
#### Gráficos con ggplot: 3) realizo gráfico

```r
ggplot(data = df_porcentajes, aes(x = Var1, y = Freq)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Gráfico de Barras de Género", x = "Género", y = "Porcentaje (%)") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) # pasa a formato porcentaje
```

&lt;img src="Clase-11-Presentación_files/figure-html/unnamed-chunk-28-1.png" width="100%" /&gt;
---
##### Gráficos con ggplot: 4) voy puliendo gráfico, agrego un tema y cambio colores

```r
#a) agrego un tema y cambio colores
ggplot(data = df_porcentajes, aes(x = Var1, y = Freq, fill = Var1)) +geom_bar(stat = "identity") +
  labs(title = "Gráfico de Barras de Género", x = "Género", y = "Porcentaje (%)") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) + theme_minimal() +  # Aplicar un tema minimal
  scale_fill_brewer(palette = "Set3") # Usar una paleta de colores Brewer
```

&lt;img src="Clase-11-Presentación_files/figure-html/unnamed-chunk-29-1.png" width="100%" /&gt;
---
4) voy puliendo gráfico, elimino etiquetas, nombre de ejes y angulo de textos

```r
#b) elimino etiquetas, nombre de ejes y angulo de textos
ggplot(data = df_porcentajes, aes(x = Var1, y = Freq, fill = Var1)) +geom_bar(stat = "identity") +
  labs(title = "Gráfico de Barras de Género", caption = "fuente: Prueba Piloto: II Encuesta Estudiantes Antropología UAH") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +theme_minimal() +  # Aplicar un tema minimal
  scale_fill_brewer(palette = "Set3")  + # Usar una paleta de colores Brewer
  guides(fill = "none")+ #elimino cuadro de etiquetas 
  xlab("") + ylab("") + #elimino nombre de ejes 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

&lt;img src="Clase-11-Presentación_files/figure-html/unnamed-chunk-30-1.png" width="100%" /&gt;
---


```r
ggplot(data = df_tabla_frecuencia, aes(x = fct_reorder(Var1, Freq), y = Freq, fill = Var1))+
  geom_bar(stat = "identity", fill = "grey") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) 
```

&lt;img src="Clase-11-Presentación_files/figure-html/unnamed-chunk-31-1.png" width="100%" /&gt;

---
* **ggplot(...)**: Inicia un nuevo gráfico utilizando los datos del DataFrame df_tabla_frecuencia.
  + aes(...): Define las estéticas del gráfico.
  + x = fct_reorder(Var1, Freq): Esto reordena las categorías en el eje X (horizontal) según los valores en la columna Freq. Las categorías se ordenarán de mayor a menor frecuencia.
  + y = Freq: Muestra la frecuencia en el eje Y (vertical) del gráfico de barras.
  + fill = Var1: El relleno de las barras se basa en los valores de la columna Var1, lo que significa que cada categoría tendrá un color diferente en el gráfico de barras.

**geom_bar(stat = "identity", fill = "grey")**:
  + geom_bar(...): Agrega la capa de barras al gráfico.
  + stat = "identity": Indica que las alturas de las barras se definen directamente por los valores en la columna Freq del DataFrame.
  + fill = "grey": Establece el color de relleno de las barras en gris.

* **theme(axis.text.x = element_text(angle = 90, hjust = 1)**
  + theme(...): Permite personalizar aspectos del tema del gráfico.
  + axis.text.x = element_text(...): Aplica las configuraciones al texto en el eje X.
  + angle = 90: Rota el texto del eje X en un ángulo de 90 grados (vertical).
  + hjust = 1: Alinea el texto del eje X hacia la derecha, lo que es útil cuando el texto está en posición vertical para que esté justo en la parte inferior de las barras.




---

class: inverse, center, middle

# Vamos a la sintaxis...
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"slideNumberFormat": "%current%",
"highlightStyle": "github",
"highlightLines": true,
"ratio": "16:9",
"countIncrementalSlides": true,
"figure_width": 8,
"figure_height": 4
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
